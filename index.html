<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Tracker — Single File</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Rich text editor (Quill) for improved note editing -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
  <!-- Markdown + sanitizer for note popovers -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">Time Tracker</div>
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">          <div id="viewHelp" class="subtle"></div>
        </div>
      </div>
      <div>
        <button id="btnSettings" class="icon-btn" title="Settings">&#9881;</button>
      </div>
    </div>

    <div class="top-controls" id="topControls" style="display:flex; justify-content: space-between; align-items:center; gap:8px;">
      <div id="dayLabel" class="subtle" title="Open calendar" tabindex="0" role="button"></div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="subtle" style="display:flex; align-items:center; gap:6px;">
          <span>Schedule</span>
          <select id="scheduleSelect" title="Select schedule" style="max-width:200px;"></select>
          <button id="btnAddSchedule" class="btn ghost" title="Add schedule">Add</button>
          <button id="btnRenameSchedule" class="btn ghost" title="Rename schedule">Rename</button>
          <button id="btnDeleteSchedule" class="btn ghost" title="Delete schedule">Delete</button>
        </div>
        <button id="btnDashboard" class="btn ghost" title="Open dashboard">Dashboard</button>
        <button id="btnCustomizeDay" class="btn ghost" title="Customize day layout">Customize Day</button>
        <button id="btnCustomizeMonth" class="btn ghost" title="Customize month layout">Customize Month</button>
        <button id="btnCalendar" class="btn ghost" title="Open calendar">Calendar</button>
        <button id="btnCopyChartTop" class="btn ghost" title="Copy timeline chart to clipboard">⧉ Copy</button>
      </div>
    </div>

    <section class="card calendar" id="calendarCard" style="display:none; padding:16px;">
      <div class="calendar-header" style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px; padding:0 4px;">
        <button class="btn ghost" id="calPrev" title="Previous">&#171;</button>
        <div id="calMonthLabel" style="font-weight:700; letter-spacing:.2px;"></div>
        <button class="btn ghost" id="calNext" title="Next">&#187;</button>
      </div>
      <div class="calendar-weekdays" id="calWeekdays" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; margin-bottom:6px;">
        <div class="cal-weekday">Sun</div>
        <div class="cal-weekday">Mon</div>
        <div class="cal-weekday">Tue</div>
        <div class="cal-weekday">Wed</div>
        <div class="cal-weekday">Thu</div>
        <div class="cal-weekday">Fri</div>
        <div class="cal-weekday">Sat</div>
      </div>
      <div class="calendar-grid" id="calendarGrid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:6px;"></div>
    </section>

    <section class="card" id="dashboardCard" style="display:none;">
      <div class="card-head">
        <div class="card-title">Dashboard</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnAddModule" class="btn">Add Module</button>
        </div>
      </div>
      <div id="dashboardGrid" class="card-body" style="display:grid; grid-template-columns: 1fr; gap:12px;"></div>
    </section>

    <!-- Month View Layout (modular; visible only in Calendar days mode) -->
    <section class="card" id="monthDashboardCard" style="display:none;">
      <div class="card-head">
        <div class="card-title">Month View Layout</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnAddMonthModule" class="btn">Add Module</button>
        </div>
      </div>
      <div id="monthDashboardGrid" class="card-body" style="display:grid; grid-template-columns: 1fr; gap:12px;"></div>
    </section>

    <!-- Day View Layout (modular) -->
    <section class="card" id="dayDashboardCard" style="display:none;">
      <div class="card-head">
        <div class="card-title">Day View Layout</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnAddDayModule" class="btn">Add Module</button>
        </div>
      </div>
      <div id="dayDashboardGrid" class="card-body" style="display:grid; grid-template-columns: 1fr; gap:12px;"></div>
    </section>

    <section class="card timeline">
      <div class="track" id="track" aria-label="Timeline track" role="application">
        <div class="ghost" id="ghost"></div>
        <div class="tip" id="tipStart"></div>
        <div class="tip" id="tipEnd"></div>
        <div class="tip tip-center" id="tipCenter"></div>
        <div class="tick-labels" id="ticks"></div>
      </div>
      <!-- Mobile: timeline zoom/pan controls -->
      <div class="mobile-controls" id="mobileControls">
        <button id="mobileZoomOut" class="btn ghost mobile-zoom" title="Zoom out" aria-label="Zoom out">&#8722;</button>
        <div id="mobileScrollbar" class="mobile-scrollbar" aria-label="Timeline viewport">
          <div id="mobileWindow" class="mobile-window" role="slider" aria-valuemin="0" aria-valuemax="1440" aria-valuenow="0" aria-label="Visible time window"></div>
        </div>
        <button id="mobileZoomIn" class="btn ghost mobile-zoom" title="Zoom in" aria-label="Zoom in">&#43;</button>
        <input id="mobileZoomRange" class="mobile-zoom-range" type="range" min="45" max="1440" step="15" value="720" aria-label="Zoom" />
      </div>
      <div class="help-row">
        <div>
          New: drag anywhere. Edit: drag a block's side handle.
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="viewDefault" class="btn ghost" title="Reset to 6am–6pm" style="padding:6px 10px; font-size:12px;">6–6</button>
          <button id="view24" class="btn ghost" title="Show 24 hours" style="padding:6px 10px; font-size:12px;">24h</button>
          <button id="btnCalendar2" class="btn ghost" title="Open calendar" style="padding:6px 10px; font-size:12px;">Calendar</button>
          <button id="btnCopyChart" class="btn ghost" title="Copy timeline chart to clipboard" style="padding:6px 10px; font-size:12px;">⧉ Copy</button>
          <div id="total" class="subtle"></div>
        </div>
      </div>
    </section>

    <section class="card table-card" id="entriesCard">
      <div class="card-head">
        <div class="card-title">Time Entries</div>
        <button id="entriesToggle" class="collapse-btn" aria-expanded="true" aria-controls="entriesBody" title="Collapse">▾</button>
      </div>
      <div id="entriesBody" class="card-body scrollable">
      <table id="entriesTable">
        <thead>
          <tr>
            <th style="width:40px"></th>
            <th style="width:140px">Start</th>
            <th style="width:140px">Stop</th>
            <th style="width:150px">Duration</th>
            <th style="width:180px">Bucket</th>
            <th>Note</th>
            <th style="width:120px; white-space:nowrap">Actions <button id="btnCopyChartTable" class="icon-btn" title="Copy timeline chart to clipboard" aria-label="Copy timeline">⧉</button></th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div class="empty" id="empty">No entries yet. Create your first by dragging on the timeline.</div>
      </div>
    </section>

    <section class="card table-card" id="bucketDayCard">
      <div class="card-head">
        <div class="card-title subtle">Bucket Report (Day)</div>
        <button id="bucketDayToggle" class="collapse-btn" aria-expanded="true" aria-controls="bucketDayBodyWrap" title="Collapse">▾</button>
      </div>
      <div id="bucketDayBodyWrap" class="card-body scrollable">
      <table>
        <thead>
          <tr>
            <th>Bucket</th>
            <th style="width:160px">Duration</th>
          </tr>
        </thead>
        <tbody id="bucketDayBody"></tbody>
      </table>
      <div class="empty" id="bucketDayEmpty">No time tracked for this day.</div>
      </div>
    </section>

    <section class="card table-card" id="bucketMonthCard" style="display:none;">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px 0 14px;">
        <div class="subtle" style="font-weight:700; letter-spacing:.2px;">Bucket Report (Month) <span id="bucketMonthTitle"></span></div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Bucket</th>
            <th style="width:160px">Duration</th>
          </tr>
        </thead>
        <tbody id="bucketMonthBody"></tbody>
      </table>
      <div class="empty" id="bucketMonthEmpty">No time tracked for this month.</div>
    </section>

    <!-- Bucket View -->
    <section class="card table-card" id="bucketViewCard" style="display:none;">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px 0 14px;">
        <div class="subtle" style="font-weight:700; letter-spacing:.2px;">Bucket View: <span id="bucketViewTitle"></span> <span id="bucketViewTotal" class="subtle"></span></div>
        <div style="display:flex; gap:8px;">
          <button id="btnBucketBack" class="btn" title="Return to calendar">Back to Calendar</button>
          <button id="btnBucketDelete" class="btn danger" title="Delete all entries in this bucket">Delete Bucket</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:140px">Date</th>
            <th style="width:140px">Start</th>
            <th style="width:140px">Stop</th>
            <th style="width:150px">Duration</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="bucketViewBody"></tbody>
      </table>
      <div class="empty" id="bucketViewEmpty">No entries found for this bucket.</div>
    </section>
  </div>

  <!-- Module modal -->
  <div class="modal-backdrop" id="moduleModal" style="display:none;">
    <div class="card modal">
      <div class="modal-header">
        <div class="modal-title">Add Module</div>
        <button class="icon-btn" id="moduleClose" aria-label="Close">&#x2715;</button>
      </div>
      <form id="moduleForm">
        <div class="body">
          <div class="row" style="grid-template-columns: 1fr 1fr;">
            <div>
              <label>Type</label>
              <select id="moduleType">
                <option value="timeline">Timeline</option>
                <option value="entries">Time Entries</option>
                <option value="bucket">Bucket Report</option>
              </select>
            </div>
            <div>
              <label>Title (optional)</label>
              <input id="moduleTitle" type="text" placeholder="Custom title" />
            </div>
          </div>
          <div class="row" style="grid-template-columns: 1fr;">
            <div>
              <label>Schedules</label>
              <div id="moduleScheduleList" style="display:flex; gap:12px; flex-wrap:wrap;"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn ghost" id="moduleCancel">Cancel</button>
          <button type="submit" class="btn primary">Add</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" id="modal">
    <div class="card modal modal-lg">
      <div class="modal-header">
        <div class="modal-title">New Time Block</div>
        <button class="icon-btn" id="modalClose" aria-label="Close">&#x2715;</button>
      </div>
      <form id="modalForm">
        <div class="body">
          <div class="row">
            <div>
              <label>Start</label>
              <input type="text" id="startField" placeholder="e.g. 9:00am" />
            </div>
            <div>
              <label>End</label>
              <input type="text" id="endField" placeholder="e.g. 5:30pm" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Schedule</label>
              <input type="text" id="scheduleField" list="scheduleList" placeholder="Type or select a schedule" />
              <datalist id="scheduleList"></datalist>
              <div class="subtle">Type a new name to create a schedule</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Status</label>
              <div class="status-wrap" id="modalStatusWrap">
                <button type="button" class="status-btn status-default" id="modalStatusBtn" aria-label="Status"></button>
                <div class="status-menu" id="modalStatusMenu">
                  <div class="status-option" data-value="default" title="Default"></div>
                  <div class="status-option" data-value="green" title="Green (transparent)"></div>
                  <div class="status-option" data-value="green-solid" title="Green"></div>
                  <div class="status-option" data-value="yellow" title="Yellow (transparent)"></div>
                  <div class="status-option" data-value="yellow-solid" title="Yellow"></div>
                  <div class="status-option" data-value="red" title="Red (transparent)"></div>
                  <div class="status-option" data-value="red-solid" title="Red"></div>
                  <div class="status-option" data-value="blue" title="Blue (transparent)"></div>
                  <div class="status-option" data-value="blue-solid" title="Blue"></div>
                  <div class="status-option" data-value="purple" title="Purple (transparent)"></div>
                  <div class="status-option" data-value="purple-solid" title="Purple"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Bucket</label>
              <input type="text" id="bucketField" placeholder="e.g. A-01" required />
            </div>
            <div>
              <label>Note</label>
              <textarea id="noteField" placeholder="Write a note… Markdown supported"></textarea>
              <div class="note-foot subtle">
                <span>Markdown supported</span>
                <span aria-hidden="true"> · </span>
                <a id="notePreviewToggle" href="#" role="button">Preview</a>
              </div>
              <div id="notePreview" class="note-preview" style="display:none;"></div>
            </div>
          </div>
          <div class="row note-dual">
            <div class="note-section">
              <div class="note-section-title">Bucket Note (persistent)</div>
              <textarea id="bucketNoteField" placeholder="Write a note... Markdown supported"></textarea>
              <div class="note-foot subtle">
                <span>Markdown supported</span>
                <span aria-hidden="true"> &bull; </span>
                <a id="bucketNotePreviewToggle" href="#" role="button">Preview</a>
              </div>
              <div id="bucketNotePreview" class="note-preview" style="display:none;"></div>
            </div>
            <div class="note-section">
              <div class="note-section-title">Punch Note</div>
              <textarea id="noteField2" placeholder="Write a note... Markdown supported"></textarea>
              <div class="note-foot subtle">
                <span>Markdown supported</span>
                <span aria-hidden="true"> • </span>
                <a id="notePreviewToggle2" href="#" role="button">Preview</a>
              </div>
              <div id="notePreview2" class="note-preview" style="display:none;"></div>
            </div>
          </div>
          <div class="row" id="repeatRow" style="grid-template-columns: 1fr;">
            <div>
              <label>Repeat</label>
              <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <label style="display:flex; align-items:center; gap:6px;">
                  <input type="checkbox" id="repeatEnabled" /> Enable recurrence
                </label>
                <div id="repeatFields" style="display:none; width:100%;">
                  <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-top:6px;">
                    <div>
                      <label>Frequency</label>
                      <select id="repeatFreq">
                        <option value="daily">Every day</option>
                        <option value="weekly" selected>Every week</option>
                        <option value="monthly">Every month</option>
                        <option value="yearly">Every year</option>
                      </select>
                    </div>
                  </div>
                  <div id="repeatDowWrap" style="display:none; margin-top:8px;">
                    <label>Days of week</label>
                    <div class="dow-picker" id="repeatDow">
                      <label class="chip"><input type="checkbox" value="1" />Mon</label>
                      <label class="chip"><input type="checkbox" value="2" />Tue</label>
                      <label class="chip"><input type="checkbox" value="3" />Wed</label>
                      <label class="chip"><input type="checkbox" value="4" />Thu</label>
                      <label class="chip"><input type="checkbox" value="5" />Fri</label>
                      <label class="chip"><input type="checkbox" value="6" />Sat</label>
                      <label class="chip"><input type="checkbox" value="0" />Sun</label>
                    </div>
                    <div class="dow-presets">
                      <button type="button" class="btn ghost" id="btnDowWeekdays" style="padding:6px 10px; font-size:12px;">Mon–Fri</button>
                      <button type="button" class="btn ghost" id="btnDowAll" style="padding:6px 10px; font-size:12px;">All Days</button>
                    </div>
                  </div>
                  <div id="repeatUntilWrap" style="margin-top:6px;">
                    <label>End on date</label>
                    <input type="date" id="repeatUntil" />
                  </div>
                </div>
              </div>
            </div>
            <div id="applyScopeWrap" style="display:none; margin-top:6px;">
              <label>Apply changes to</label>
              <div style="display:flex; gap:14px;">
                <label><input type="radio" name="applyScope" id="applyScopeOne" value="one" /> Only this</label>
                <label><input type="radio" name="applyScope" id="applyScopeSeries" value="series" checked /> Entire series</label>
              </div>
            </div>
            <div id="extendWrap" style="display:none; margin-top:10px;">
              <label>Extend series</label>
              <div style="display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end;">
                <div>
                  <label>Extend until</label>
                  <input type="date" id="extendUntil" />
                </div>
                <button type="button" class="btn" id="btnExtendSeries">Extend</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn danger" id="modalDelete">Delete</button>
          <button type="button" class="btn ghost" id="modalCancel">Cancel</button>
          <button type="submit" class="btn primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Settings modal -->
  <div class="modal-backdrop" id="settingsModal">
    <div class="card modal">
      <div class="modal-header">
        <div class="modal-title">Settings</div>
        <button class="icon-btn" id="settingsClose" aria-label="Close">&#x2715;</button>
      </div>
      <div class="body" style="padding-top: 4px;">
        <div class="row" style="grid-template-columns: 1fr;">
          <div>
            <label>Schedules</label>
            <div style="display:grid; gap:10px;">
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <select id="settingsSchedList" title="Schedules" style="min-width:220px;"></select>
                <button id="settingsAddSched" class="btn" title="Add a new schedule with the name below">Add</button>
                <button id="settingsRenameSched" class="btn ghost" title="Rename the selected schedule to the name below">Rename</button>
                <button id="settingsDeleteSched" class="btn danger" title="Delete the selected schedule">Delete</button>
              </div>
              <div style="display:grid; grid-template-columns: 1fr; gap:8px;">
                <div>
                  <label>Name</label>
                  <input id="settingsSchedName" type="text" placeholder="Schedule name" />
                </div>
                <div id="settingsDeleteConfirm" style="display:none; padding:8px; border:1px solid rgba(255,255,255,0.15); border-radius:8px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <div id="settingsDeleteConfirmText">Confirm delete?</div>
                    <div style="display:flex; gap:8px;">
                      <button id="settingsDeleteYes" class="btn danger">Confirm Delete</button>
                      <button id="settingsDeleteNo" class="btn ghost">Cancel</button>
                    </div>
                  </div>
                </div>
                <div id="settingsSchedMsg" class="subtle" aria-live="polite"></div>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                  <div class="subtle" style="margin-bottom:6px;">Move Entries Between Schedules</div>
                  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:end;">
                    <div>
                      <label>From</label>
                      <select id="settingsMoveFrom"></select>
                    </div>
                    <div>
                      <label>To</label>
                      <select id="settingsMoveTo"></select>
                    </div>
                    <div>
                      <label>Start Date (optional)</label>
                      <input type="date" id="settingsMoveStart" />
                    </div>
                    <div>
                      <label>End Date (optional)</label>
                      <input type="date" id="settingsMoveEnd" />
                    </div>
                    <div style="grid-column: 1 / -1; display:flex; gap:8px; align-items:center;">
                      <button id="settingsMoveBtn" class="btn">Move</button>
                      <div class="subtle">Overlaps in destination are detected and skipped.</div>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="subtle" style="margin-bottom:6px;">Dashboard</div>
                  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <button id="settingsCustomizeDashboard" class="btn">Customize Dashboard…</button>
                    <div class="subtle">Opens Dashboard and Add Module dialog.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row" style="grid-template-columns: 1fr;">
          <div>
            <label>Theme</label>
            <select id="themeSelect">
              <option value="neon">Neon (default)</option>
              <option value="light">Light</option>
            </select>
          </div>
        </div>
        <div class="row" style="grid-template-columns: 1fr 1fr; align-items:end;">
          <div>
            <label id="lblBackup" style="cursor:pointer;">Backup</label>
            <button id="btnExport" class="btn primary" style="width:100%;">Export Data</button>
          </div>
          <div>
            <label id="lblRestore" style="cursor:pointer;">Restore</label>
            <button id="btnImport" class="btn primary" style="width:100%;">Import Data (merge)</button>
            <input id="importFile" type="file" accept="application/json" style="display:none;" />
          </div>
        </div>
        <div class="row" style="grid-template-columns: 1fr;">
          <div>
            <label>Danger zone</label>
            <button id="btnEraseAll" class="btn danger" style="width:100%;">Erase All Data</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn ghost" id="settingsCancel">Close</button>
      </div>
    </div>
  </div>

  <!-- Note modal -->
  <div class="modal-backdrop" id="noteModal">
    <div class="card modal modal-xl">
      <div class="modal-header">
        <div class="modal-title" id="noteModalTitle">Note</div>
        <button class="icon-btn" id="noteModalClose" aria-label="Close">&#x2715;</button>
      </div>
      <div class="body">
        <div class="note-dual">
          <div class="note-section">
            <div class="note-section-title">Bucket Note (persistent)</div>
            <div id="bucketNoteViewer" class="note-view" style="display:none;"></div>
            <div id="bucketNoteEditorWrap">
              <div id="bucketNoteEditor" class="rich-editor"></div>
            </div>
          </div>
          <div class="note-section">
            <div class="note-section-title">Punch Note</div>
            <div id="noteViewer" class="note-view" style="display:none;"></div>
            <div id="noteEditorWrap">
              <div id="noteEditor" class="rich-editor"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn ghost" id="noteEditToggle" style="display:none;">Edit</button>
        <button type="button" class="btn primary" id="noteSave">Save</button>
        <button type="button" class="btn ghost" id="noteCancel">Close</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Floating calendar toggle removed: click the day label or use header controls -->

  <script type="module" src="app.js"></script>
  
</body>
</html>

